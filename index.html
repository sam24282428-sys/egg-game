<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è›‹äº†ä¸ªè›‹ - å®Œç¾å¸ƒå±€ç‰ˆ</title>
    <style>
        :root {
            --card-w: 48px;  /* ç¨å¾®ç¼©å°å¡ç‰‡ä»¥ä¾¿é“ºå¼€ */
            --card-h: 56px;
            --bg-color: #c5e1a5;
            --slot-bg: #3e2723;
        }
        
        * { box-sizing: border-box; touch-action: manipulation; }

        body {
            margin: 0;
            background-color: var(--bg-color);
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            user-select: none;
            -webkit-user-select: none;
        }

        header {
            height: 44px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            background: rgba(255,255,255,0.6);
            color: #33691e;
            font-weight: bold;
            font-size: 15px;
            z-index: 10;
        }

        /* æ¸¸æˆåŒºåŸŸ */
        #game-stage {
            flex: 1;
            position: relative;
            width: 100%;
            max-width: 480px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œæ¨¡æ‹Ÿæ‰‹æœºå± */
            margin: 0 auto;
            overflow: hidden; /* é˜²æ­¢å¡ç‰‡é£å‡º */
        }

        /* å¡ç‰‡æ ·å¼ä¼˜åŒ–ï¼šå¼ºè°ƒå±‚çº§æ„Ÿ */
        .card {
            width: var(--card-w);
            height: var(--card-h);
            background: #fff;
            border-radius: 6px;
            border: 1px solid #795548;
            border-bottom: 5px solid #5d4037; /* åŠ åšåº•éƒ¨æ¨¡æ‹Ÿåšåº¦ */
            border-right: 3px solid #5d4037;  /* åŠ åšå³ä¾§å¢åŠ ç«‹ä½“ */
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.1s, filter 0.2s;
            /* æŠ•å½±ç¨å¾®æ‰©æ•£ä¸€ç‚¹ï¼Œçœ‹æ¸…ä¸Šä¸‹å…³ç³» */
            box-shadow: 3px 3px 6px rgba(0,0,0,0.3); 
            will-change: transform, left, top;
        }

        /* é®æŒ¡çŠ¶æ€ï¼šå˜æš—ç¨‹åº¦åŠ æ·±ï¼Œä¸”ç¨å¾®é€æ˜ä¸€ç‚¹ç‚¹ï¼Œæ–¹ä¾¿çœ‹ä¸‹é¢ */
        .card.covered {
            filter: brightness(0.5);
            background-color: #ddd;
            color: rgba(0,0,0,0.5);
        }
        
        /* æ¶ˆé™¤æ—¶çš„åŠ¨ç”» */
        .card.removing {
            transform: scale(0) rotate(180deg);
            transition: all 0.3s ease-in;
        }

        /* åº•éƒ¨UIç»“æ„ */
        #bottom-area {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            padding-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255,255,255,0.1);
            border-radius: 20px 20px 0 0;
        }

        #extra-zone {
            height: 60px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        #tools-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 8px;
        }
        
        .tool-btn {
            background: none; border: none; cursor: pointer; position: relative;
            display: flex; flex-direction: column; align-items: center;
        }
        .tool-icon {
            width: 42px; height: 42px; background: #fff; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-size: 20px;
            border: 2px solid #8d6e63;
            box-shadow: 0 3px 0 #5d4037;
        }
        .tool-btn:active .tool-icon { transform: translateY(3px); box-shadow: none; }
        .tool-text { font-size: 10px; color: #33691e; margin-top: 2px; font-weight: bold;}
        .badge { position: absolute; top: -2px; right: -5px; background: #f44336; color: #fff; font-size: 10px; padding: 2px 5px; border-radius: 10px; }

        /* å¡æ§½å®¹å™¨ */
        #slot-container {
            width: 96%;
            height: 70px;
            background: var(--slot-bg);
            border-radius: 10px;
            border: 3px solid #4e342e;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 5px;
        }

        .slot-card {
            position: static !important;
            margin: 0 1px;
            box-shadow: none;
            width: 42px; height: 48px; font-size: 20px;
            border: 1px solid #aaa; border-bottom: 3px solid #888;
            background: #fff; border-radius: 4px;
            display: flex; justify-content: center; align-items: center;
        }

        /* å¼¹çª— */
        #modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center;
        }
        .btn-start {
            background: linear-gradient(#ffca28, #ff6f00);
            border: none; padding: 12px 40px; border-radius: 30px;
            font-size: 22px; font-weight: bold; margin-top: 20px;
            box-shadow: 0 4px #e65100; cursor: pointer;
        }
        .btn-start:active { transform: translateY(4px); box-shadow: none; }

    </style>
</head>
<body>

    <header>
        <span id="level-txt">ç¬¬ 1 å…³</span>
        <span id="card-count">å‰©ä½™: 0</span>
    </header>

    <div id="game-stage"></div>

    <div id="bottom-area">
        <div id="extra-zone"></div>
        <div id="tools-bar">
            <button class="tool-btn" onclick="useTool('move')">
                <div class="tool-icon">ğŸ“¤</div><span class="tool-text">ç§»å‡º</span>
                <div class="badge" id="n-move">0</div>
            </button>
            <button class="tool-btn" onclick="useTool('undo')">
                <div class="tool-icon">ğŸ”™</div><span class="tool-text">æ’¤å›</span>
                <div class="badge" id="n-undo">0</div>
            </button>
            <button class="tool-btn" onclick="useTool('shuffle')">
                <div class="tool-icon">ğŸ”€</div><span class="tool-text">æ´—ç‰Œ</span>
                <div class="badge" id="n-shuffle">0</div>
            </button>
        </div>
        <div id="slot-container"></div>
    </div>

    <div id="modal">
        <h1 style="font-size: 40px; margin-bottom:10px">ğŸ¥š è›‹äº†ä¸ªè›‹</h1>
        <p id="modal-msg" style="color:#ccc; font-size: 16px; padding: 0 20px;">ä¼˜åŒ–ç‰ˆï¼šå¸ƒå±€åˆ†æ•£ï¼Œé®æŒ¡æ¸…æ™°</p>
        <button class="btn-start" onclick="initGame()">å¼€å§‹æŒ‘æˆ˜</button>
    </div>

    <script>
        // ================= é…ç½® =================
        const CONFIG = {
            cardW: 48,
            cardH: 56,
            slotMax: 7,
            // ä¸°å¯Œçš„è›‹ä¸»é¢˜Emoji
            emojis: [
                'ğŸ¥š','ğŸ³','ğŸ£','ğŸ¤','ğŸ¥©','ğŸ–','ğŸ—','ğŸ”','ğŸŸ','ğŸ•','ğŸŒ­','ğŸ¥ª','ğŸŒ®','ğŸŒ¯','ğŸ¥™','ğŸ¥˜'
            ]
        };

        // ================= å…¨å±€çŠ¶æ€ =================
        let state = {
            lvl: 1,
            cards: [],      // åœºä¸Šå¡ç‰‡
            slot: [],       // æ§½å†…å¡ç‰‡
            extra: [],      // æš‚å­˜åŒº
            history: [],    // æ’¤å›æ ˆ
            tools: { move: 0, undo: 0, shuffle: 0 },
            animating: false
        };

        let audioCtx = null;

        // ================= å…³å¡éš¾åº¦è¡¨ =================
        // pairs: ç”Ÿæˆå¤šå°‘ç»„(æ¯ç»„3å¼ )ã€‚
        // layers: æœŸæœ›å †å å¤šå°‘å±‚ã€‚
        // spread: åˆ†æ•£ç¨‹åº¦ (small=é›†ä¸­, large=å…¨å±)
        const LEVELS = [
            { pairs: 3,   layers: 1, spread: 'center' }, // L1: 9å¼ ï¼Œå¹³é“º
            { pairs: 10,  layers: 2, spread: 'mid' },    // L2: 30å¼ ï¼Œå¾®å 
            { pairs: 25,  layers: 4, spread: 'large' },  // L3: 75å¼ ï¼Œåˆ†æ•£
            { pairs: 45,  layers: 6, spread: 'large' },  // L4: 135å¼ ï¼Œå¤šå³°
            { pairs: 80,  layers: 9, spread: 'max' }     // L5: 240å¼ ï¼Œå…¨å±è¦†ç›–
        ];

        function initAudio() {
            if(!audioCtx && (window.AudioContext || window.webkitAudioContext)) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(freq, type='sine') {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.15);
        }

        function initGame() {
            state.lvl = 1;
            // åˆå§‹é€ä¸€ç‚¹é“å…·
            state.tools = { move: 1, undo: 1, shuffle: 1 };
            startGame();
        }

        function startGame() {
            initAudio();
            const modal = document.getElementById('modal');
            modal.style.display = 'none';
            
            state.cards = [];
            state.slot = [];
            state.extra = [];
            state.history = [];
            state.animating = false;

            // æ¯ä¸€å…³å¢åŠ é“å…·
            if(state.lvl > 1) {
                state.tools.move++;
                state.tools.undo++;
                state.tools.shuffle++;
            }
            updateTools();

            document.getElementById('level-txt').innerText = `ç¬¬ ${state.lvl} å…³`;
            document.getElementById('game-stage').innerHTML = '';
            document.getElementById('slot-container').innerHTML = '';
            document.getElementById('extra-zone').innerHTML = '';

            generateLevel(state.lvl - 1);
        }

        // ================= æ ¸å¿ƒå¸ƒå±€ç®—æ³• (Grid System) =================
        function generateLevel(lvlIdx) {
            const cfg = LEVELS[lvlIdx > 4 ? 4 : lvlIdx];
            const totalCards = cfg.pairs * 3;
            
            // 1. å‡†å¤‡å¡æ± 
            // éšç€å…³å¡å¢åŠ ï¼Œç´ æç§ç±»(types)å¢å¤š
            const typeCount = Math.min(CONFIG.emojis.length, 3 + lvlIdx * 2); 
            let deck = [];
            for(let i=0; i<cfg.pairs; i++) {
                const type = CONFIG.emojis[i % typeCount];
                deck.push(type, type, type);
            }
            deck.sort(() => Math.random() - 0.5);

            // 2. è®¡ç®—ç½‘æ ¼
            // æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªè™šæ‹Ÿç½‘æ ¼ï¼Œå•å…ƒæ ¼å¤§å°ä¸ºå¡ç‰‡å®½é«˜çš„ä¸€åŠ
            // è¿™æ ·å¯ä»¥å®ç°â€œåŠé®åŠéœ²â€çš„ç –å¢™æ•ˆæœ
            const stageW = document.getElementById('game-stage').clientWidth;
            const stageH = document.getElementById('game-stage').clientHeight;
            
            const gridW = CONFIG.cardW / 2; 
            const gridH = CONFIG.cardH / 2; 
            
            const cols = Math.floor(stageW / gridW) - 2; // ç•™è¾¹è·
            const rows = Math.floor(stageH / gridH) - 4;
            
            const startCol = 1;
            const startRow = 1;

            // ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„åæ ‡ç‚¹ (x, y, layer)
            let positions = [];

            // åˆ†å±‚ç”Ÿæˆé€»è¾‘
            for(let layer = 0; layer < cfg.layers; layer++) {
                // æ¯ä¸€å±‚çš„å¡ç‰‡æ•°é‡é€æ¸å‡å°‘ (å½¢æˆé‡‘å­—å¡”)
                // æˆ–è€…ç‰¹å®šå½¢çŠ¶
                
                // è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šåˆ›å»ºä¸€ä¸ª mask (æ©ç å›¾)ï¼Œå†³å®šè¿™ä¸€å±‚å“ªé‡Œèƒ½æ”¾ç‰Œ
                let validSlots = [];

                for(let r = startRow; r < rows; r++) {
                    for(let c = startCol; c < cols; c++) {
                        // æ£€æŸ¥è§„åˆ™ï¼š
                        // 1. å¿…é¡»è¦åˆ†æ•£ï¼šå¥‡æ•°å±‚å’Œå¶æ•°å±‚é”™å¼€
                        // 2. è¾¹ç¼˜æ§åˆ¶ï¼šè¶Šå¾€ä¸Šå±‚ï¼ŒèŒƒå›´è¶Šå°(èšæ‹¢) æˆ–è€… å½¢æˆå¤šä¸ªå±±å³°
                        
                        let canPlace = false;
                        
                        // å½’ä¸€åŒ–åæ ‡ (-1 åˆ° 1)
                        const nx = (c / cols - 0.5) * 2;
                        const ny = (r / rows - 0.5) * 2;
                        const dist = Math.sqrt(nx*nx + ny*ny); // è·ç¦»ä¸­å¿ƒè·ç¦»

                        if (cfg.spread === 'center') {
                            if (dist < 0.8 - layer * 0.2) canPlace = true;
                        } 
                        else if (cfg.spread === 'large' || cfg.spread === 'max') {
                            // å…¨å±å‡åŒ€åˆ†å¸ƒï¼Œä½†éšæœºæŒ–ç©º
                            // è¶Šå¾€ä¸Šå±‚ï¼ŒæŒ–ç©ºè¶Šå¤š
                            if (Math.random() > (layer * 0.15)) canPlace = true;
                            // å¼ºåˆ¶è¾¹è·
                            if (dist > 0.9) canPlace = false;
                        }
                        else { // mid
                            if (dist < 1.2 - layer * 0.3) canPlace = true;
                        }

                        if(canPlace) {
                            // åæ ‡æŠ–åŠ¨ï¼šä¸ºäº†ä¸è®©å®ƒçœ‹èµ·æ¥å¤ªæ­»æ¿ï¼Œåƒæœºå™¨äººæ‘†çš„
                            // æˆ‘ä»¬ç»™ç½‘æ ¼åæ ‡åŠ ä¸€ç‚¹ç‚¹åç§»ï¼Œä½†ä¿æŒåœ¨é®æŒ¡é€»è¾‘å†…
                            const offsetX = (Math.random() - 0.5) * 10; 
                            const offsetY = (Math.random() - 0.5) * 10; 

                            validSlots.push({
                                x: c * gridW + (stageW - cols*gridW)/2 + offsetX,
                                y: r * gridH + (stageH - rows*gridH)/2 + offsetY,
                                layer: layer
                            });
                        }
                    }
                }
                
                // æ‰“ä¹±è¿™ä¸€å±‚çš„æ§½ä½
                validSlots.sort(() => Math.random() - 0.5);
                positions = positions.concat(validSlots);
            }

            // æˆªå–éœ€è¦çš„æ•°é‡ (å¦‚æœæœ‰å¤šçš„æ§½ä½å°±ä¸¢å¼ƒï¼Œå¦‚æœä¸å¤Ÿå°±æ²¡åŠæ³•äº†åªèƒ½å †å )
            // ä¸ºäº†ä¿è¯ç‰Œä¸é‡å åœ¨å®Œå…¨ä¸€æ ·çš„ä½ç½®ï¼Œæˆ‘ä»¬åªå–å‰Nä¸ª
            // æ³¨æ„ï¼šè¿™é‡Œæ˜¯ä¸€ä¸ªç®€åŒ–ï¼Œç†æƒ³æƒ…å†µæ˜¯ç¡®ä¿ positions.length >= totalCards
            
            // 3. åˆ›å»ºå¡ç‰‡
            for(let i=0; i<deck.length; i++) {
                if (i >= positions.length) break; // æ§½ä½ä¸å¤Ÿ(ç†è®ºä¸Šå¾ˆéš¾å‘ç”Ÿ)
                
                const pos = positions[i]; // æ‹¿åˆ°ä¸€ä¸ªç©ºä½
                const emoji = deck[i];
                
                createCard(i, emoji, pos.x, pos.y, pos.layer); // ä½¿ç”¨ layer ä½œä¸ºåŸºç¡€ zIndex
            }

            updateOcclusion();
            updateCount();
        }

        function createCard(id, emoji, x, y, layer) {
            const el = document.createElement('div');
            el.className = 'card';
            el.innerText = emoji;
            
            // è®¾ç½®æ ·å¼
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            // zIndex é€»è¾‘ï¼šå±‚çº§ * 100 + idã€‚
            // è¿™æ ·ä¿è¯äº†é«˜å±‚çš„è‚¯å®šåœ¨ä½å±‚ä¸Šé¢ï¼ŒåŒå±‚çš„æŒ‰ç”Ÿæˆé¡ºåº
            const zIndex = layer * 100 + id; 
            el.style.zIndex = zIndex;
            
            const card = {
                id: id,
                emoji: emoji,
                x: x,
                y: y,
                z: zIndex, // ç”¨äºè®¡ç®—é®æŒ¡
                layer: layer,
                el: el,
                status: 'board'
            };

            el.onmousedown = (e) => { e.preventDefault(); clickCard(card); };
            el.ontouchstart = (e) => { e.preventDefault(); clickCard(card); };

            document.getElementById('game-stage').appendChild(el);
            state.cards.push(card);
        }

        // ================= é®æŒ¡è®¡ç®— (ç²¾ç¡®ç‰ˆ) =================
        function updateOcclusion() {
            const active = state.cards.filter(c => c.status === 'board');
            
            // æ’åºï¼šå…ˆæŒ‰Zè½´æ’åºï¼Œä¼˜åŒ–æ£€æµ‹æ€§èƒ½
            active.sort((a,b) => a.z - b.z);

            active.forEach(me => {
                let isCovered = false;
                // åªæ£€æŸ¥ z æ¯”æˆ‘å¤§çš„
                for(let other of active) {
                    if (other.z <= me.z) continue;

                    // ç®€å•çš„çŸ©å½¢ç¢°æ’ (Shrink Box)
                    // å¡ç‰‡å®½48ï¼Œé«˜56ã€‚
                    // å¦‚æœä¸¤å¼ å¡ç‰‡ä¸­å¿ƒè·ç¦»å°äºä¸€å®šé˜ˆå€¼ï¼Œå°±ç®—é®æŒ¡ã€‚
                    // ä¸ºäº†è®©é®æŒ¡æ›´åˆç†ï¼Œæˆ‘ä»¬ç¨å¾®ç¼©å°åˆ¤å®šèŒƒå›´ (40x48)
                    // åªæœ‰å½“ä¸Šé¢çš„ç‰Œé®ä½äº†ä¸‹é¢ç‰Œçš„ 80% ä»¥ä¸Šé¢ç§¯æ—¶æ‰ç®—é®æŒ¡ï¼Ÿ
                    // ä¸ï¼ŒåŸç‰ˆé€»è¾‘æ˜¯ï¼šåªè¦å‹ä½ä¸€ç‚¹è§’ï¼Œä¸‹é¢å°±ä¸èƒ½ç‚¹ã€‚
                    
                    const dx = Math.abs(me.x - other.x);
                    const dy = Math.abs(me.y - other.y);
                    
                    // é˜ˆå€¼ï¼šåªè¦é‡å è¶…è¿‡ 4px å°±ç®—é®æŒ¡ã€‚
                    // å¡ç‰‡W=48, H=56
                    if (dx < (CONFIG.cardW - 4) && dy < (CONFIG.cardH - 6)) {
                        isCovered = true;
                        break;
                    }
                }

                if(isCovered) {
                    me.el.classList.add('covered');
                } else {
                    me.el.classList.remove('covered');
                }
            });
        }

        // ================= æ¸¸æˆé€»è¾‘ =================
        function clickCard(card) {
            if(state.animating || card.status !== 'board') return;
            
            if(card.el.classList.contains('covered')) {
                // éœ‡åŠ¨åé¦ˆ
                card.el.style.transform = 'translateX(-3px)';
                setTimeout(() => card.el.style.transform = 'translateX(3px)', 50);
                setTimeout(() => card.el.style.transform = 'none', 100);
                playSound(150, 'sawtooth');
                return;
            }

            if(state.slot.length >= CONFIG.slotMax) {
                playSound(100, 'square');
                return;
            }

            // è®°å½•æ“ä½œ
            state.history.push({action:'pick', c: card, from: {x:card.x, y:card.y, z:card.z} });

            playSound(600, 'sine');
            
            // ç§»å…¥æ§½ä½
            card.status = 'slot';
            card.el.classList.remove('card');
            card.el.classList.add('slot-card');
            card.el.style.zIndex = 'auto';
            
            document.getElementById('slot-container').appendChild(card.el);
            state.slot.push(card);

            updateOcclusion(); // åˆ·æ–°é®æŒ¡
            checkMatch();
        }

        function checkMatch() {
            const counts = {};
            state.slot.forEach(c => counts[c.emoji] = (counts[c.emoji]||0)+1);
            
            let matchType = null;
            for(let t in counts) if(counts[t] >= 3) { matchType = t; break; }

            if(matchType) {
                state.animating = true;
                setTimeout(() => {
                    playSound(880, 'triangle');
                    // ç§»é™¤åŠ¨ç”»
                    const keep = [];
                    let removed = 0;
                    state.slot.forEach(c => {
                        if(c.emoji === matchType && removed < 3) {
                            c.el.classList.add('removing'); // css åŠ¨ç”»
                            setTimeout(() => c.el.remove(), 300);
                            removed++;
                        } else {
                            keep.push(c);
                        }
                    });
                    state.slot = keep;
                    
                    setTimeout(() => {
                        state.animating = false;
                        // é‡æ–°appendä»¥æ’åº
                        const con = document.getElementById('slot-container');
                        state.slot.forEach(c => con.appendChild(c.el));
                        updateCount();
                        checkWin();
                    }, 300);
                }, 200);
            } else {
                updateCount();
                if(state.slot.length >= CONFIG.slotMax) {
                    setTimeout(() => showResult(false), 500);
                } else {
                    checkWin();
                }
            }
        }

        function checkWin() {
            const left = state.cards.filter(c => c.status === 'board' || c.status === 'extra').length;
            if(left === 0 && state.slot.length === 0) {
                setTimeout(() => showResult(true), 300);
            }
        }

        function showResult(win) {
            const modal = document.getElementById('modal');
            const msg = document.getElementById('modal-msg');
            const btn = modal.querySelector('button');
            
            modal.style.display = 'flex';
            if(win) {
                playSound(1000, 'sine');
                msg.innerText = `å¤ªå¼ºäº†ï¼æˆåŠŸé€šè¿‡ç¬¬ ${state.lvl} å…³ï¼`;
                btn.innerText = "ä¸‹ä¸€å…³";
                btn.onclick = () => {
                    state.lvl++;
                    startGame();
                };
            } else {
                playSound(200, 'sawtooth');
                msg.innerText = "æ§½ä½å·²æ»¡ï¼Œè¿˜è¦ç»§ç»­å—ï¼Ÿ";
                btn.innerText = "é‡è¯•æœ¬å…³";
                btn.onclick = startGame;
            }
        }

        function updateCount() {
            const n = state.cards.filter(c => c.status === 'board' || c.status === 'extra').length;
            document.getElementById('card-count').innerText = `å‰©ä½™: ${n}`;
        }

        function updateTools() {
            document.getElementById('n-move').innerText = state.tools.move;
            document.getElementById('n-undo').innerText = state.tools.undo;
            document.getElementById('n-shuffle').innerText = state.tools.shuffle;
            // å˜ç°é€»è¾‘ç•¥
        }

        // ================= é“å…·é€»è¾‘ =================
        window.useTool = function(type) {
            if(state.tools[type] <= 0) return;

            if(type === 'shuffle') {
                const board = state.cards.filter(c => c.status === 'board');
                if(!board.length) return;
                // äº¤æ¢åæ ‡
                const positions = board.map(c => ({x:c.x, y:c.y, z:c.z}));
                positions.sort(()=>Math.random()-0.5);
                board.forEach((c,i) => {
                    c.x = positions[i].x; c.y = positions[i].y; c.z = positions[i].z;
                    c.el.style.left = c.x+'px'; c.el.style.top = c.y+'px'; c.el.style.zIndex = c.z;
                });
                updateOcclusion();
                playSound(500);
            } 
            else if(type === 'undo') {
                if(!state.slot.length) return;
                const c = state.slot.pop();
                // å°è¯•æ¢å¤
                const h = state.history.find(x => x.c.id === c.id);
                if(h) {
                    c.x = h.from.x; c.y = h.from.y; c.z = h.from.z;
                }
                c.status = 'board';
                c.el.className = 'card';
                c.el.classList.remove('slot-card');
                c.el.style.left = c.x+'px'; c.el.style.top = c.y+'px'; c.el.style.zIndex = c.z;
                
                document.getElementById('game-stage').appendChild(c.el);
                updateOcclusion();
            }
            else if(type === 'move') {
                if(state.slot.length < 3) return; // å¿…é¡»æ»¡3ä¸ªæ‰ç§»
                const toMove = state.slot.splice(0, 3);
                toMove.forEach(c => {
                    c.status = 'extra';
                    c.el.className = 'card'; // æ ·å¼è¿˜åŸ
                    c.el.style.position = 'static';
                    c.el.onclick = () => {
                        // ç§»å›
                        if(state.slot.length >= CONFIG.slotMax) return;
                        c.status = 'slot';
                        c.el.className = 'slot-card';
                        c.el.onclick = null;
                        document.getElementById('slot-container').appendChild(c.el);
                        state.extra = state.extra.filter(x=>x.id!==c.id);
                        state.slot.push(c);
                        checkMatch();
                    }
                    document.getElementById('extra-zone').appendChild(c.el);
                    state.extra.push(c);
                });
                // é‡æ–°æ¸²æŸ“æ§½ä½
                const con = document.getElementById('slot-container');
                state.slot.forEach(c => con.appendChild(c.el));
            }

            state.tools[type]--;
            updateTools();
        }

    </script>
</body>
</html>